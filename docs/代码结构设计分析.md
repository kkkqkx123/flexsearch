# FlexSearch 代码结构设计分析

## 项目概览

FlexSearch 是一个**下一代全文搜索引擎库**，专为浏览器和 Node.js 设计。项目采用高度模块化的架构，支持多种构建配置和运行环境。

## 核心架构设计

### 1. 条件编译系统

项目使用了一套**精细的条件编译系统**，通过 `src/config.js` 控制功能模块的启用/禁用：

```javascript
export const SUPPORT_WORKER = true;
export const SUPPORT_ENCODER = true;
export const SUPPORT_CACHE = true;
export const SUPPORT_ASYNC = true;
export const SUPPORT_SERIALIZE = true;
export const SUPPORT_PERSISTENT = true;
export const SUPPORT_RESOLVER = true;
export const SUPPORT_HIGHLIGHTING = true;
```

这种设计允许：
- 按需构建不同体积的包（bundle, compact, light, es5）
- 禁用不需要的功能以减小包体积
- 支持多种输出格式（UMD, ESM, CommonJS）

### 2. 双索引模型

#### Index 类 - `src/index.js`
用于**简单文本搜索**，核心特性：
- 基于 Map 的倒排索引结构
- 支持上下文搜索（context search）
- 支持多种分词策略
- 可配置的评分系统

#### Document 类 - `src/document.js`
用于**复杂文档搜索**，核心特性：
- 多字段索引支持
- 字段存储（store）功能
- 标签（tags）过滤
- 结果高亮（highlighting）
- 嵌套字段解析

## 核心模块分析

### 1. Encoder 编码器 - `src/encoder.js`

**设计亮点**：
- **13步处理流水线**：normalize → prepare → numeric split → split → dedupe → filter → stemmer → mapper → dedupe → matcher → replacer → dedupe → finalize
- **智能缓存机制**：自动平衡的 LRU 缓存
- **多语言支持**：通过 charset 模块支持不同语言
- **可扩展性**：支持自定义编码器

```javascript
// 编码流水线示例
Encoder.prototype.encode = function(str, dedupe_terms){
    // 1. charset normalization
    // 2. custom prepare
    // 3. numeric splitting
    // 4. term splitting
    // 5. filtering
    // 6. stemming
    // 7. mapping
    // 8. matching
    // 9. finalization
}
```

### 2. Keystore 优化存储 - `src/keystore.js`

**创新设计**：
- **KeystoreMap/KeystoreSet**：使用线性同余生成器（LCG）进行哈希分桶
- **KeystoreArray**：解决 JavaScript 数组长度限制（2³¹-1），支持超大数组
- **内存优化**：通过分桶减少内存碎片

```javascript
// LCG 哈希算法
function lcg(str) {
    let range = 2 ** this.bit - 1;
    let crc = 0, bit = this.bit + 1;
    for(let i = 0; i < str.length; i++) {
        crc = (crc * bit ^ str.charCodeAt(i)) & range;
    }
    return this.bit === 32 ? crc + 2 ** 31 : crc;
}
```

### 3. Resolver 查询解析器 - `src/resolver.js`

**链式查询设计**：
- 支持延迟执行（lazy evaluation）
- 支持异步查询链
- 提供 AND、OR、XOR、NOT 等逻辑操作
- 支持 boost（权重调整）

### 4. Intersect 交集算法 - `src/intersect.js`

**高性能实现**：
- 基于对象的快速查找（O(1)）
- 支持多级评分（resolution）
- 支持 suggestion 模式（模糊匹配）
- 早期退出优化

### 5. Cache 缓存系统 - `src/cache.js`

**LRU 缓存设计**：
- 自动淘汰最久未使用的条目
- 基于查询参数生成缓存键
- 支持缓存失效

### 6. Worker 多线程支持 - `src/worker.js`

**跨平台 Worker**：
- 浏览器：Web Worker
- Node.js：worker_threads
- 动态创建 Worker 实例
- Promise 化的 API

### 7. Persistent 持久化 - `src/db/interface.js`

**存储抽象层**：
- 统一的存储接口
- 支持多种后端：
  - IndexedDB
  - SQLite
  - MongoDB
  - PostgreSQL
  - Redis
  - ClickHouse

## 索引数据结构

### 倒排索引设计

```
Index 结构：
├── map: Map<term, Array<IDs>>  // 主索引
├── ctx: Map<ctx, Map<term, Array<IDs>>>  // 上下文索引
└── reg: Set<IDs>  // ID 注册表

Document 结构：
├── index: Map<field, Index>  // 多字段索引
├── store: Map<id, document>  // 文档存储
└── tag: Map<field, Map<tag, Set<IDs>>>  // 标签索引
```

### 评分系统

- **Resolution**：将文档分成多个评分区间
- **Position-based**：基于词位置的评分
- **Customizable**：支持自定义评分函数

## 构建系统

### 多种构建变体

1. **bundle**：完整功能，支持所有特性
2. **compact**：精简版，移除 Worker 和持久化
3. **light**：轻量级，仅核心搜索功能
4. **es5**：ES5 兼容版本

### 构建流程

```
src/ → task/build → dist/
├── module/        (ESM 格式)
├── node/          (Node.js 格式)
└── *.min.js       (UMD 格式)
```

## 性能优化策略

1. **Fast Update**：快速更新模式，维护反向引用
2. **Compression**：术语压缩（可选）
3. **Resolution**：分级评分，减少计算量
4. **Early Exit**：早期退出优化
5. **Keystore**：优化的键值存储
6. **Caching**：多层缓存策略

## 设计模式应用

1. **工厂模式**：Index 和 Document 的构造函数
2. **策略模式**：Encoder 的可配置流水线
3. **代理模式**：Keystore 的 Proxy 实现
4. **观察者模式**：Worker 的消息传递
5. **适配器模式**：Persistent 存储接口

## 目录结构

```
flexsearch-0.8.2/
├── src/                    # 源代码目录
│   ├── charset/           # 字符集编码器
│   │   ├── latin/         # 拉丁语系编码器
│   │   ├── cjk.js         # 中日韩编码器
│   │   └── ...
│   ├── db/               # 持久化数据库适配器
│   │   ├── indexeddb/
│   │   ├── redis/
│   │   ├── sqlite/
│   │   └── ...
│   ├── document/          # 文档索引操作
│   │   ├── add.js
│   │   ├── search.js
│   │   └── highlight.js
│   ├── index/             # 基础索引操作
│   │   ├── add.js
│   │   ├── search.js
│   │   └── remove.js
│   ├── resolve/           # 查询解析器
│   │   ├── and.js
│   │   ├── or.js
│   │   ├── xor.js
│   │   └── not.js
│   ├── worker/            # Worker 支持
│   │   ├── handler.js
│   │   ├── node.js
│   │   └── worker.js
│   ├── async.js          # 异步支持
│   ├── bundle.js         # 打包入口
│   ├── cache.js          # 缓存系统
│   ├── charset.js        # 字符集管理
│   ├── common.js         # 通用工具函数
│   ├── compress.js       # 压缩功能
│   ├── config.js         # 配置管理
│   ├── document.js       # Document 类
│   ├── encoder.js        # 编码器
│   ├── index.js          # Index 类
│   ├── intersect.js      # 交集算法
│   ├── keystore.js       # 优化的键值存储
│   ├── preset.js         # 预设配置
│   ├── profiler.js       # 性能分析
│   ├── resolver.js       # 查询解析器
│   ├── serialize.js      # 序列化
│   ├── type.js           # 类型定义
│   └── worker.js         # Worker 索引
├── dist/                 # 构建输出目录
│   ├── module/           # ESM 模块
│   ├── module-debug/     # 调试版本
│   ├── module-min/       # 压缩版本
│   ├── db/               # 数据库适配器
│   ├── lang/             # 语言包
│   └── *.js             # 各种构建版本
├── example/              # 示例代码
│   ├── browser-legacy/
│   ├── browser-module/
│   └── nodejs-commonjs/
├── doc/                  # 文档目录
├── docs/                 # 中文文档
├── demo/                 # 演示文件
└── task/                 # 构建任务
```

## 总结

FlexSearch 的代码结构设计体现了以下核心思想：

1. **模块化**：高度解耦的模块设计
2. **可配置**：通过条件编译实现按需构建
3. **高性能**：多种优化策略和数据结构
4. **可扩展**：清晰的接口和插件机制
5. **跨平台**：统一的 API，支持浏览器和 Node.js
6. **渐进增强**：从 light 到 bundle 的功能递增

这种设计使得 FlexSearch 既能在资源受限的环境中运行，也能在需要完整功能的企业应用中使用。
