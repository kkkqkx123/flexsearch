# FlexSearch 中间层架构设计

## 一、架构概述

FlexSearch 中间层采用 Go + Rust 混合架构，充分发挥两种语言的优势。Go 用于网络服务和协调层，Rust 用于高性能计算密集型任务。

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                    客户端                              │
└────────────────────┬────────────────────────────────────┘
                     │ HTTP/gRPC
                     ▼
┌─────────────────────────────────────────────────────────┐
│              API 网关                  │
│              Go 实现                                    │
│  - 认证授权                                             │
│  - 限流熔断                                             │
│  - 请求路由                                             │
└────────────────────┬────────────────────────────────────┘
                     │ gRPC
                     ▼
┌─────────────────────────────────────────────────────────┐
│          查询协调器                    │
│          Go 实现                                        │
│  - 查询路由                                             │
│  - 并行执行                                             │
│  - 结果融合                                             │
└────────────┬───────────┬───────────┬───────────────────┘
             │           │           │
             ▼           ▼           ▼
┌─────────────────┐ ┌─────────────┐ ┌─────────────────┐
│ FlexSearch 服务  │ │ BM25 服务   │ │ 向量搜索服务     │
│ Rust 实现        │ │ Rust 实现    │ │ Rust 实现        │
│ - 关键词搜索     │ │ - 全文搜索   │ │ - 语义搜索       │
│ - 模糊匹配       │ │ - BM25 算法  │ │ - 向量检索       │
└─────────────────┘ └─────────────┘ └─────────────────┘
```

### 1.2 语言分工

| 模块 | 语言 | 理由 |
|------|------|------|
| API 网关 | Go | 高并发、网络服务、开发效率高 |
| 查询协调器 | Go | 并发协调、网络通信、逻辑简单 |
| FlexSearch 服务 | Rust | 计算密集、极致性能、内存安全 |
| BM25 服务 | Rust | 算法计算、性能优化、内存安全 |
| 向量搜索服务 | Rust | 向量计算、SIMD 优化、内存安全 |
| 插件系统 | Go | 动态加载、生态丰富、开发效率 |

---

## 二、模块列表

### 2.1 核心模块

| 模块 | 语言 | 职责 |
|------|------|------|
| **API 网关** | Go | 统一入口、认证授权、限流熔断、请求路由 |
| **查询协调器** | Go | 查询路由、并行执行、结果融合、缓存管理 |
| **FlexSearch 服务** | Rust | 关键词搜索、模糊匹配、短语搜索、结果高亮 |
| **BM25 服务** | Rust | 全文搜索、BM25 算法、词频统计、参数调优 |
| **向量搜索服务** | Rust | 语义搜索、向量嵌入、混合搜索、HNSW 索引 |
| **插件系统** | Go | 插件加载、钩子系统、插件管理、配置管理 |

---

## 三、模块职责

### 3.1 API 网关（Go）

**核心职责**：
- 接收外部 HTTP 请求，转换为内部 gRPC 调用
- 实现 JWT Token 验证和 API Key 认证
- 基于用户或 IP 实现限流控制
- 监控后端服务健康状态，实现熔断机制
- 记录请求日志和响应日志
- 实现请求和响应的格式转换

**主要逻辑**：
1. 请求拦截：拦截所有进入的 HTTP 请求
2. 认证验证：验证请求中的认证信息
3. 限流检查：检查请求频率是否超过阈值
4. 路由转发：根据请求路径转发到对应的后端服务
5. 响应转换：将后端服务的响应转换为客户端需要的格式
6. 错误处理：统一处理各种错误情况

**目录结构**：
```
services/api-gateway/
├── cmd/
│   └── main.go              # 入口文件
├── internal/
│   ├── config/              # 配置管理
│   ├── middleware/          # 中间件
│   │   ├── auth.go         # 认证中间件
│   │   ├── ratelimit.go    # 限流中间件
│   │   ├── logger.go       # 日志中间件
│   │   └── recovery.go     # 恢复中间件
│   ├── handler/             # HTTP 处理器
│   │   ├── search.go       # 搜索接口
│   │   ├── document.go     # 文档接口
│   │   └── health.go       # 健康检查
│   ├── client/              # gRPC 客户端
│   │   └── coordinator.go  # 协调器客户端
│   └── util/                # 工具函数
└── proto/                   # gRPC 协议定义
```

### 3.2 查询协调器（Go）

**核心职责**：
- 接收来自 API 网关的查询请求
- 根据查询类型和配置路由到合适的搜索引擎
- 并行调用多个搜索引擎
- 融合多个搜索引擎的结果
- 实现查询缓存
- 监控搜索引擎的健康状态

**主要逻辑**：
1. 查询分析：分析查询特征（长度、类型、特殊字符等）
2. 路由决策：根据查询特征决定使用哪些搜索引擎
3. 并行调用：同时调用多个搜索引擎，提高响应速度
4. 结果融合：使用 RRF 或加权算法融合多个引擎的结果
5. 缓存管理：缓存查询结果，提高响应速度
6. 错误处理：处理搜索引擎的错误和超时

**目录结构**：
```
services/coordinator/
├── cmd/
│   └── main.go              # 入口文件
├── internal/
│   ├── config/              # 配置管理
│   ├── router/              # 查询路由器
│   │   ├── router.go       # 路由决策
│   │   └── strategy.go     # 路由策略
│   ├── merger/              # 结果融合器
│   │   ├── merger.go       # 融合接口
│   │   ├── rrf.go          # RRF 策略
│   │   └── weighted.go     # 加权策略
│   ├── engine/              # 搜索引擎客户端
│   │   ├── flexsearch.go   # FlexSearch 客户端
│   │   ├── bm25.go         # BM25 客户端
│   │   └── vector.go       # 向量搜索客户端
│   ├── cache/               # 缓存管理
│   │   └── redis.go        # Redis 缓存
│   └── util/                # 工具函数
└── proto/                   # gRPC 协议定义
```

### 3.3 FlexSearch 服务（Rust）

**核心职责**：
- 提供高性能的关键词搜索
- 支持精确匹配、模糊匹配、短语搜索
- 实现文档索引的添加、更新、删除
- 支持结果高亮显示
- 提供搜索建议和自动完成
- 实现查询缓存

**主要逻辑**：
1. 文档索引：将文档内容分词并建立倒排索引
2. 查询处理：解析查询，处理通配符和特殊字符
3. 搜索执行：在倒排索引中查找匹配的文档
4. 结果排序：根据相关性对结果进行排序
5. 高亮显示：在结果中高亮显示匹配的关键词
6. 缓存管理：缓存热门查询的结果

**目录结构**：
```
services/flexsearch/
├── src/
│   ├── main.rs              # 入口文件
│   ├── lib.rs               # 库入口
│   ├── config/              # 配置管理
│   ├── index/               # 索引管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 索引管理器
│   │   └── builder.rs      # 索引构建器
│   ├── search/              # 搜索管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 搜索管理器
│   │   ├── highlight.rs    # 高亮显示
│   │   └── suggest.rs      # 搜索建议
│   ├── tokenizer/           # 分词器
│   │   ├── mod.rs          # 模块入口
│   │   └── simple.rs       # 简单分词器
│   ├── cache/               # 缓存管理
│   │   ├── mod.rs          # 模块入口
│   │   └── redis.rs        # Redis 缓存
│   └── storage/             # 持久化
│       ├── mod.rs          # 模块入口
│       └── redis.rs        # Redis 存储
├── proto/                   # gRPC 协议定义
└── Cargo.toml               # Rust 项目配置
```

### 3.4 BM25 服务（Rust）

**核心职责**：
- 提供基于 BM25 算法的全文搜索
- 实现词频统计和文档频率统计
- 支持 k1 和 b 参数调优
- 支持多语言分词
- 实现结果高亮显示
- 提供统计信息查询

**主要逻辑**：
1. 文档索引：将文档内容分词，统计词频
2. 统计计算：计算文档频率、平均文档长度等统计信息
3. BM25 评分：根据 BM25 公式计算文档相关性得分
4. 查询处理：解析查询，处理布尔操作符
5. 结果排序：根据 BM25 得分对结果进行排序
6. 参数调优：支持动态调整 k1 和 b 参数

**目录结构**：
```
services/bm25/
├── src/
│   ├── main.rs              # 入口文件
│   ├── lib.rs               # 库入口
│   ├── config/              # 配置管理
│   ├── index/               # 索引管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 索引管理器
│   │   └── stats.rs        # 统计管理器
│   ├── search/              # 搜索管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 搜索管理器
│   │   └── scorer.rs       # BM25 评分器
│   ├── tokenizer/           # 分词器
│   │   ├── mod.rs          # 模块入口
│   │   └── multilingual.rs # 多语言分词器
│   ├── cache/               # 缓存管理
│   │   ├── mod.rs          # 模块入口
│   │   └── redis.rs        # Redis 缓存
│   └── storage/             # 持久化
│       ├── mod.rs          # 模块入口
│       └── postgres.rs     # PostgreSQL 存储
├── proto/                   # gRPC 协议定义
└── Cargo.toml               # Rust 项目配置
```

### 3.5 向量搜索服务（Rust）

**核心职责**：
- 提供基于向量嵌入的语义搜索
- 集成嵌入模型生成向量
- 实现向量索引（HNSW）
- 支持混合搜索（关键词 + 向量）
- 支持向量量化减少内存占用
- 提供多模型支持

**主要逻辑**：
1. 文档索引：将文档内容转换为向量，建立向量索引
2. 向量生成：调用嵌入模型将文本转换为向量
3. 向量搜索：使用余弦相似度或欧氏距离查找相似向量
4. 混合搜索：结合关键词搜索和向量搜索的结果
5. 向量量化：使用量化技术减少向量索引的内存占用
6. 模型管理：支持多种嵌入模型的切换

**目录结构**：
```
services/vector/
├── src/
│   ├── main.rs              # 入口文件
│   ├── lib.rs               # 库入口
│   ├── config/              # 配置管理
│   ├── index/               # 索引管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 索引管理器
│   │   └── hnsw.rs         # HNSW 索引
│   ├── search/              # 搜索管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 搜索管理器
│   │   └── hybrid.rs       # 混合搜索
│   ├── embedding/           # 嵌入管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 嵌入管理器
│   │   └── models.rs       # 嵌入模型
│   ├── cache/               # 缓存管理
│   │   ├── mod.rs          # 模块入口
│   │   └── redis.rs        # Redis 缓存
│   └── storage/             # 持久化
│       ├── mod.rs          # 模块入口
│       └── qdrant.rs       # Qdrant 存储
├── proto/                   # gRPC 协议定义
└── Cargo.toml               # Rust 项目配置
```

### 3.6 插件系统（Go）

**核心职责**：
- 动态加载和卸载插件
- 提供钩子系统，允许插件在特定时机执行逻辑
- 管理插件的生命周期
- 解析和管理插件依赖
- 提供插件配置管理
- 实现插件热更新

**主要逻辑**：
1. 插件发现：扫描插件目录，发现可用的插件
2. 插件加载：加载插件的代码和配置
3. 依赖解析：解析插件的依赖关系，确保依赖满足
4. 钩子注册：注册插件提供的钩子
5. 钩子执行：在合适的时机执行插件的钩子
6. 插件卸载：卸载插件，清理资源

**目录结构**：
```
services/plugin-system/
├── cmd/
│   └── main.go              # 入口文件
├── internal/
│   ├── config/              # 配置管理
│   ├── manager/             # 插件管理器
│   │   ├── loader.go       # 插件加载器
│   │   ├── lifecycle.go    # 生命周期管理
│   │   └── registry.go     # 插件注册表
│   ├── hook/                # 钩子系统
│   │   ├── emitter.go      # 钩子发射器
│   │   └── registry.go     # 钩子注册表
│   ├── dependency/          # 依赖管理
│   │   └── resolver.go     # 依赖解析器
│   └── util/                # 工具函数
├── plugins/                # 内置插件
│   ├── search/
│   │   ├── personalization/
│   │   └── ab-testing/
│   ├── filter/
│   │   ├── content/
│   │   └── sensitive/
│   └── analytics/
│       └── user-behavior/
└── proto/                   # gRPC 协议定义
```

---

## 四、服务间通信

### 4.1 通信协议

所有服务间通信使用 gRPC 协议，确保高效、类型安全的通信。

### 4.2 通信流程

1. 客户端发起 HTTP 请求到 API 网关
2. API 网关验证认证和限流后，通过 gRPC 调用查询协调器
3. 查询协调器根据查询类型，通过 gRPC 并行调用多个搜索引擎
4. 搜索引擎执行搜索并返回结果
5. 查询协调器融合结果后返回给 API 网关
6. API 网关将结果转换为 HTTP 响应返回给客户端

---

## 五、数据存储

### 5.1 存储方案

| 服务 | 存储方案 | 用途 |
|------|---------|------|
| FlexSearch 服务 | Redis | 索引存储、缓存 |
| BM25 服务 | PostgreSQL | 文档存储、全文搜索 |
| 向量搜索服务 | Qdrant | 向量存储、向量索引 |
| 查询协调器 | Redis | 查询缓存 |
| API 网关 | Redis | 限流计数、会话存储 |

### 5.2 数据流

1. 文档索引：客户端通过 API 网关提交文档，查询协调器路由到对应的搜索引擎，搜索引擎将文档存储到对应的数据库
2. 查询搜索：客户端通过 API 网关提交查询，查询协调器路由到对应的搜索引擎，搜索引擎从数据库检索数据并返回结果

---

## 六、技术选型

### 6.1 Go 技术栈

| 技术 | 用途 |
|------|------|
| Gin | HTTP 框架 |
| gRPC | 服务间通信 |
| Redis | 缓存、限流 |
| Zap | 日志系统 |
| Prometheus | 监控指标 |

### 6.2 Rust 技术栈

| 技术 | 用途 |
|------|------|
| Tokio | 异步运行时 |
| Tonic | gRPC 框架 |
| Redis | 缓存、存储 |
| Qdrant | 向量数据库 |
| Postgres | 全文搜索 |
| Tracing | 日志系统 |
| Metrics | 监控指标 |

---

## 七、设计原则

### 7.1 架构原则

1. **语言优势最大化**：Go 用于网络服务，Rust 用于计算密集型任务
2. **服务解耦**：每个服务独立部署，互不影响
3. **高性能优先**：核心搜索引擎使用 Rust 实现极致性能
4. **可扩展性**：支持水平扩展，增加服务实例
5. **容错性**：实现熔断、降级、重试等容错机制

### 7.2 代码原则

1. **简洁性**：代码简洁明了，易于理解和维护
2. **模块化**：每个模块职责单一，高内聚低耦合
3. **可测试性**：代码易于测试，单元测试覆盖率高
4. **可观测性**：完善的日志、监控和追踪
5. **安全性**：输入验证、认证授权、数据加密

---

## 八、部署架构

### 8.1 部署方式

所有服务都支持 Docker 容器化部署，可以使用 Kubernetes 进行编排。

### 8.2 服务依赖

```
API 网关 → 查询协调器 → FlexSearch 服务 → Redis
                              → BM25 服务 → PostgreSQL
                              → 向量搜索服务 → Qdrant
```

### 8.3 扩展策略

1. **API 网关**：水平扩展，增加实例数
2. **查询协调器**：水平扩展，增加实例数
3. **搜索引擎**：水平扩展，增加实例数
4. **存储层**：使用数据库集群或分片
