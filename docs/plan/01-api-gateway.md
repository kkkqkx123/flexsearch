# API 网关模块设计

## 一、模块概述

API 网关是整个系统的统一入口，负责接收外部 HTTP 请求，进行认证授权、限流熔断、请求路由等处理，然后将请求转发到后端服务。使用 Go 语言实现，利用其高并发特性和丰富的网络服务生态。

---

## 二、核心功能

### 2.1 功能列表

| 功能 | 描述 |
|------|------|
| **请求路由** | 根据请求路径和类型路由到不同的后端服务 |
| **认证授权** | JWT Token 验证、API Key 认证 |
| **限流熔断** | 基于用户或 IP 的限流、服务熔断 |
| **日志记录** | 请求日志、响应日志、错误日志 |
| **健康检查** | 网关自身和后端服务的健康检查 |
| **请求转换** | 格式转换、数据过滤 |

### 2.2 API 接口

#### 搜索接口
```
POST /api/v1/search
GET  /api/v1/search

请求参数：
- query: 搜索关键词
- limit: 返回结果数量
- offset: 偏移量
- filters: 过滤条件
- options: 搜索选项（engine, enrich, highlight）

响应：
- results: 搜索结果列表
- total: 总数
- latency: 延迟
- engine: 使用的搜索引擎
```

#### 文档管理接口
```
POST   /api/v1/documents
GET    /api/v1/documents/:id
PUT    /api/v1/documents/:id
DELETE /api/v1/documents/:id
POST   /api/v1/documents/batch
```

#### 索引管理接口
```
POST   /api/v1/indexes
GET    /api/v1/indexes
GET    /api/v1/indexes/:id
DELETE /api/v1/indexes/:id
POST   /api/v1/indexes/:id/rebuild
```

#### 健康检查接口
```
GET /health
GET /health/services
```

---

## 三、架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────┐
│         客户端                  │
└──────────────┬──────────────────────┘
               │ HTTP/HTTPS
               ▼
┌─────────────────────────────────────────┐
│         API 网关               │
│  ┌──────────────┬──────────────┐       │
│  │ 中间件层     │ 路由层       │       │
│  └──────────────┴──────────────┘       │
│  ┌──────────────┬──────────────┐       │
│  │ 认证授权     │ 限流熔断     │       │
│  └──────────────┴──────────────┘       │
└──────────────┬──────────────────────┘
               │ gRPC
               ▼
┌─────────────────────────────────────────┐
│         查询协调器               │
└─────────────────────────────────────────┘
```

### 3.2 目录结构

```
services/api-gateway/
├── cmd/
│   └── main.go              # 入口文件
├── internal/
│   ├── config/              # 配置管理
│   │   ├── config.go       # 配置结构
│   │   └── routes.go       # 路由配置
│   ├── middleware/          # 中间件
│   │   ├── auth.go         # 认证中间件
│   │   ├── ratelimit.go    # 限流中间件
│   │   ├── logger.go       # 日志中间件
│   │   ├── recovery.go     # 恢复中间件
│   │   └── cors.go         # CORS 中间件
│   ├── handler/             # HTTP 处理器
│   │   ├── search.go       # 搜索接口
│   │   ├── document.go     # 文档接口
│   │   ├── index.go        # 索引接口
│   │   └── health.go       # 健康检查
│   ├── client/              # gRPC 客户端
│   │   ├── coordinator.go  # 协调器客户端
│   │   └── conn.go         # 连接管理
│   ├── model/               # 数据模型
│   │   ├── request.go      # 请求模型
│   │   └── response.go     # 响应模型
│   └── util/                # 工具函数
│       ├── logger.go        # 日志工具
│       ├── error.go         # 错误处理
│       └── validator.go     # 参数验证
├── proto/                   # gRPC 协议定义
│   └── coordinator.proto
├── configs/                 # 配置文件
│   └── config.yaml
├── go.mod
├── go.sum
├── Dockerfile
└── README.md
```

---

## 四、模块职责

### 4.1 配置管理模块

**职责**：
- 加载和管理应用配置
- 提供配置访问接口
- 支持配置热更新

**主要功能**：
- 从配置文件或环境变量加载配置
- 提供配置项的访问方法
- 监听配置变化并更新

### 4.2 中间件层

#### 认证中间件

**职责**：
- 验证请求中的认证信息
- 提取用户身份信息
- 拒绝未认证的请求

**主要逻辑**：
1. 从请求头或参数中提取 Token
2. 验证 Token 的有效性
3. 解析 Token 获取用户信息
4. 将用户信息存入上下文
5. 未认证则返回 401 错误

#### 限流中间件

**职责**：
- 限制请求频率
- 防止恶意请求
- 保护后端服务

**主要逻辑**：
1. 从请求中获取标识（用户 ID 或 IP）
2. 检查该标识的请求计数
3. 如果超过阈值则拒绝请求
4. 记录限流事件

#### 日志中间件

**职责**：
- 记录请求和响应日志
- 记录错误日志
- 提供日志查询接口

**主要逻辑**：
1. 记录请求信息（方法、路径、参数）
2. 记录响应信息（状态码、响应时间）
3. 记录错误信息（错误类型、堆栈）
4. 结构化日志输出

#### 恢复中间件

**职责**：
- 捕获 panic
- 记录错误信息
- 返回友好的错误响应

**主要逻辑**：
1. 使用 defer + recover 捕获 panic
2. 记录 panic 信息
3. 返回 500 错误响应

### 4.3 处理器层

#### 搜索处理器

**职责**：
- 处理搜索请求
- 调用查询协调器
- 返回搜索结果

**主要逻辑**：
1. 解析请求参数
2. 验证参数有效性
3. 调用查询协调器的搜索接口
4. 转换响应格式
5. 返回结果

#### 文档处理器

**职责**：
- 处理文档管理请求
- 调用查询协调器
- 返回操作结果

**主要逻辑**：
1. 解析请求参数
2. 验证参数有效性
3. 调用查询协调器的文档接口
4. 转换响应格式
5. 返回结果

#### 索引处理器

**职责**：
- 处理索引管理请求
- 调用查询协调器
- 返回操作结果

**主要逻辑**：
1. 解析请求参数
2. 验证参数有效性
3. 调用查询协调器的索引接口
4. 转换响应格式
5. 返回结果

#### 健康检查处理器

**职责**：
- 检查网关健康状态
- 检查后端服务健康状态
- 返回健康状态信息

**主要逻辑**：
1. 检查网关自身状态
2. 调用后端服务的健康检查接口
3. 汇总健康状态
4. 返回健康信息

### 4.4 客户端层

#### 协调器客户端

**职责**：
- 管理 gRPC 连接
- 调用查询协调器接口
- 处理连接错误

**主要逻辑**：
1. 建立 gRPC 连接
2. 调用搜索、文档、索引等接口
3. 处理连接超时和错误
4. 实现连接池和重试

### 4.5 工具层

#### 日志工具

**职责**：
- 提供统一的日志接口
- 支持多种日志级别
- 支持日志输出到文件和标准输出

#### 错误处理

**职责**：
- 定义错误类型
- 提供错误包装和转换
- 统一错误响应格式

#### 参数验证

**职责**：
- 验证请求参数
- 提供友好的错误提示
- 支持自定义验证规则

---

## 五、主要逻辑流程

### 5.1 请求处理流程

```
1. 客户端发起 HTTP 请求
2. 日志中间件记录请求信息
3. CORS 中间件处理跨域
4. 认证中间件验证认证信息
5. 限流中间件检查请求频率
6. 路由器匹配请求路径
7. 处理器处理业务逻辑
8. 客户端调用查询协调器
9. 查询协调器返回结果
10. 处理器转换响应格式
11. 日志中间件记录响应信息
12. 返回 HTTP 响应
```

### 5.2 认证流程

```
1. 从请求头 Authorization 中提取 Token
2. 验证 Token 格式（Bearer Token）
3. 解析 JWT Token
4. 验证 Token 签名和有效期
5. 提取用户信息（用户 ID、角色等）
6. 将用户信息存入上下文
7. 继续处理请求
```

### 5.3 限流流程

```
1. 从请求中获取标识（用户 ID 或 IP）
2. 在 Redis 中查询该标识的请求计数
3. 检查计数是否超过阈值
4. 如果超过阈值，返回 429 错误
5. 如果未超过，增加计数并设置过期时间
6. 继续处理请求
```

### 5.4 熔断流程

```
1. 监控后端服务的错误率
2. 当错误率超过阈值时，打开熔断器
3. 熔断器打开时，直接返回错误，不调用后端
4. 经过一段时间后，进入半开状态
5. 半开状态允许少量请求通过
6. 如果请求成功，关闭熔断器
7. 如果请求失败，重新打开熔断器
```

---

## 六、技术选型

### 6.1 核心依赖

| 依赖 | 用途 |
|------|------|
| Gin | HTTP 框架 |
| gRPC | 服务间通信 |
| Redis | 缓存、限流 |
| Zap | 日志系统 |
| Viper | 配置管理 |
| JWT-Go | JWT 认证 |
| Prometheus | 监控指标 |

### 6.2 依赖说明

**Gin**：
- 高性能 HTTP 框架
- 支持中间件机制
- 路由灵活快速

**gRPC**：
- 高效的 RPC 框架
- 支持 Protocol Buffers
- 支持流式传输

**Redis**：
- 高性能键值存储
- 支持限流计数
- 支持缓存存储

**Zap**：
- 高性能日志库
- 结构化日志
- 支持多种输出

**Viper**：
- 强大的配置管理
- 支持多种配置格式
- 支持配置热更新

**JWT-Go**：
- JWT Token 生成和验证
- 支持多种签名算法
- 支持自定义声明

**Prometheus**：
- 监控指标收集
- 支持多种指标类型
- 支持指标导出

---

## 七、设计原则

### 7.1 架构原则

1. **中间件优先**：使用中间件处理横切关注点
2. **职责单一**：每个模块职责单一，高内聚低耦合
3. **可扩展性**：易于添加新的中间件和处理器
4. **可观测性**：完善的日志、监控和追踪
5. **容错性**：实现熔断、降级、重试等容错机制

### 7.2 代码原则

1. **简洁性**：代码简洁明了，易于理解和维护
2. **可测试性**：代码易于测试，单元测试覆盖率高
3. **性能优先**：使用高效的算法和数据结构
4. **安全性**：输入验证、认证授权、数据加密
5. **错误处理**：完善的错误处理和恢复机制
