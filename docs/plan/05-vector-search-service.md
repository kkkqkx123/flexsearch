需要改为直接让协调模块集成qdrant


# 向量搜索服务模块设计

## 一、模块概述

向量搜索服务是中间层的语义搜索引擎，负责提供基于向量相似度的语义搜索功能。该服务使用 Rust 语言实现，利用其高性能计算和内存安全特性，实现高效的向量索引和相似度搜索算法。

---

## 二、核心功能

### 2.1 功能列表

| 功能 | 描述 |
|------|------|
| **文档索引** | 添加、更新、删除文档向量 |
| **向量搜索** | 基于相似度的向量搜索 |
| **批量操作** | 支持批量添加和删除 |
| **缓存管理** | 自动缓存热门查询 |
| **持久化** | 支持多种持久化后端 |
| **向量归一化** | 支持向量归一化 |
| **监控指标** | 收集性能指标 |

### 2.2 搜索特性

| 特性 | 支持 | 说明 |
|------|------|------|
| **余弦相似度** | ✅ | 基于余弦相似度的搜索 |
| **欧氏距离** | ✅ | 基于欧氏距离的搜索 |
| **点积** | ✅ | 基于点积的搜索 |
| **HNSW 索引** | ✅ | 高效的近似最近邻搜索 |
| **精确搜索** | ✅ | 精确的最近邻搜索 |
| **混合搜索** | ✅ | 结合关键词和向量搜索 |

---

## 三、架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────┐
│         查询协调器               │
└──────────────┬──────────────────────┘
               │ gRPC
               ▼
┌─────────────────────────────────────────┐
│         向量搜索服务              │
│  ┌──────────────┬──────────────┐       │
│  │ 索引管理器   │ 搜索管理器   │       │
│  └──────────────┴──────────────┘       │
│  ┌──────────────┬──────────────┐       │
│  │ 相似度计算器 │ 缓存管理器   │       │
│  └──────────────┴──────────────┘       │
└──────────────┬──────────────────────┘
               │
        ┌──────┼──────┐
        │      │        │
        ▼      ▼        ▼
┌──────────┐ ┌──────────┐ ┌──────────┐
│HNSW 索引 │ │  Redis   │ │  向量存储 │
│ 内存索引  │ │  缓存    │ │  (可选)  │
└──────────┘ └──────────┘ └──────────┘
```

### 3.2 目录结构

```
services/vector-search/
├── src/
│   ├── main.rs              # 入口文件
│   ├── lib.rs               # 库入口
│   ├── config/              # 配置管理
│   │   ├── mod.rs          # 模块入口
│   │   └── config.rs       # 配置结构
│   ├── index/               # 索引管理
│   │   ├── mod.rs          # 模块入口
│   │   ├── manager.rs      # 索引管理器
│   │   ├── builder.rs      # 索引构建器
│   │   └── hnsw.rs         # HNSW 索引
│   ├── search/              # 搜索管理
│   │   ├── mod.rs          # 模块入口
│   │   └── manager.rs      # 搜索管理器
│   ├── similarity/          # 相似度计算
│   │   ├── mod.rs          # 模块入口
│   │   ├── cosine.rs       # 余弦相似度
│   │   ├── euclidean.rs    # 欧氏距离
│   │   └── dot.rs          # 点积
│   ├── cache/               # 缓存管理
│   │   ├── mod.rs          # 模块入口
│   │   └── redis.rs        # Redis 缓存
│   ├── storage/             # 持久化
│   │   ├── mod.rs          # 模块入口
│   │   └── redis.rs        # Redis 存储
│   ├── proto/               # gRPC 服务
│   │   ├── mod.rs          # 模块入口
│   │   └── service.rs       # gRPC 服务实现
│   └── model/               # 数据模型
│       ├── mod.rs          # 模块入口
│       ├── document.rs     # 文档模型
│       └── result.rs       # 结果模型
├── proto/                   # gRPC 协议定义
│   └── vector.proto
├── configs/                 # 配置文件
│   └── config.toml
├── Cargo.toml               # Rust 项目配置
├── Dockerfile
└── README.md
```

---

## 四、模块职责

### 4.1 索引管理器

**职责**：
- 管理 HNSW 索引的创建和更新
- 处理文档向量的添加、更新、删除
- 维护索引的内存结构
- 支持索引的持久化和恢复
- 支持索引的增量更新和全量重建

**主要逻辑**：
1. 接收文档向量添加请求
2. 对向量进行归一化（可选）
3. 将向量插入 HNSW 索引
4. 更新索引的统计信息
5. 支持索引的增量更新和全量重建

**数据结构**：
- HNSW 索引：基于图的近似最近邻索引
- 向量存储：文档 ID 到向量的映射
- 统计信息：向量数量、维度等统计

### 4.2 搜索管理器

**职责**：
- 处理向量搜索请求
- 在 HNSW 索引中查找相似的向量
- 对结果进行排序和截断
- 支持多种相似度度量

**主要逻辑**：
1. 接收搜索请求
2. 对查询向量进行归一化（可选）
3. 在 HNSW 索引中查找相似的向量
4. 计算相似度分数
5. 根据相似度对结果进行排序
6. 返回排序后的结果

**搜索模式**：
- 近似搜索：使用 HNSW 索引进行近似搜索
- 精确搜索：遍历所有向量进行精确搜索
- 混合搜索：结合近似搜索和精确搜索

### 4.3 相似度计算器

**职责**：
- 实现多种相似度度量算法
- 计算向量之间的相似度
- 支持自定义相似度函数

**主要逻辑**：
1. 接收两个向量
2. 根据配置选择相似度度量
3. 计算相似度分数
4. 返回相似度分数

**相似度度量**：
- 余弦相似度：cosine_similarity = (A · B) / (||A|| * ||B||)
- 欧氏距离：euclidean_distance = sqrt(Σ(Ai - Bi)²)
- 点积：dot_product = Σ(Ai * Bi)

### 4.4 缓存管理器

**职责**：
- 缓存热门查询的结果
- 管理缓存的过期和淘汰
- 提供缓存命中率统计
- 支持缓存预热

**主要逻辑**：
1. 生成缓存键
2. 检查缓存是否存在
3. 如果缓存命中，返回缓存结果
4. 如果缓存未命中，执行查询并缓存结果
5. 管理缓存的过期和淘汰
6. 统计缓存命中率

**缓存策略**：
- LRU：最近最少使用淘汰
- TTL：基于时间的过期
- 容量限制：限制缓存大小

### 4.5 持久化管理器

**职责**：
- 将索引持久化到存储
- 从存储恢复索引
- 支持增量更新和全量同步
- 管理存储的连接和错误

**主要逻辑**：
1. 将 HNSW 索引序列化
2. 将序列化的数据写入存储
3. 从存储读取序列化的数据
4. 反序列化并重建索引
5. 处理存储错误和重试

**存储后端**：
- Redis：高性能键值存储
- 文件系统：本地文件存储
- 数据库：支持多种数据库

---

## 五、主要逻辑流程

### 5.1 文档索引流程

```
1. 接收文档向量添加请求
2. 对向量进行归一化（可选）
3. 将向量插入 HNSW 索引
4. 更新索引的统计信息
5. 将向量存入向量存储
6. 持久化索引变更
7. 返回成功响应
```

### 5.2 向量搜索流程

```
1. 接收搜索请求
2. 检查缓存是否存在
3. 如果缓存命中，返回缓存结果
4. 如果缓存未命中
   - 对查询向量进行归一化（可选）
   - 在 HNSW 索引中查找相似的向量
   - 计算相似度分数
   - 根据相似度对结果进行排序
   - 截断结果到指定数量
   - 缓存查询结果
5. 返回搜索结果
```

### 5.3 HNSW 索引构建流程

```
1. 初始化 HNSW 索引
2. 设置 HNSW 参数
   - M：每个节点的最大连接数
   - efConstruction：构建时的搜索范围
   - ef：搜索时的搜索范围
3. 逐个插入向量
   - 为每个向量找到最近的邻居
   - 建立连接关系
4. 构建多层图结构
5. 返回构建完成的索引
```

### 5.4 相似度计算流程

```
1. 接收两个向量
2. 根据配置选择相似度度量
3. 计算相似度分数
   - 余弦相似度：计算点积和向量长度
   - 欧氏距离：计算向量差的平方和
   - 点积：计算向量对应元素的乘积和
4. 返回相似度分数
```

---

## 六、技术选型

### 6.1 核心依赖

| 依赖 | 用途 |
|------|------|
| Tokio | 异步运行时 |
| Tonic | gRPC 框架 |
| Redis | 缓存、存储 |
| Tracing | 日志系统 |
| Metrics | 监控指标 |
| Serde | 序列化/反序列化 |

### 6.2 依赖说明

**Tokio**：
- 异步运行时
- 高性能的异步 I/O
- 支持任务调度和定时器

**Tonic**：
- gRPC 框架
- 支持 Protocol Buffers
- 高性能的 RPC 通信

**Redis**：
- 高性能键值存储
- 支持缓存和持久化
- 支持分布式场景

**Tracing**：
- 结构化日志
- 支持分布式追踪
- 高性能的日志记录

**Metrics**：
- 监控指标收集
- 支持多种指标类型
- 支持指标导出

**Serde**：
- 序列化和反序列化
- 支持多种数据格式
- 高性能的数据转换

---

## 七、设计原则

### 7.1 架构原则

1. **性能优先**：使用高效的数据结构和算法
2. **内存安全**：利用 Rust 的所有权系统保证内存安全
3. **并发安全**：使用线程安全的数据结构
4. **可扩展性**：易于添加新的搜索特性
5. **可观测性**：完善的日志、监控和追踪

### 7.2 代码原则

1. **简洁性**：代码简洁明了，易于理解和维护
2. **可测试性**：代码易于测试，单元测试覆盖率高
3. **模块化**：每个模块职责单一，高内聚低耦合
4. **错误处理**：完善的错误处理和恢复机制
5. **文档完善**：提供详细的 API 文档和使用示例
