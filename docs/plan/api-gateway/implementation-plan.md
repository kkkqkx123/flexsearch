# API 网关分阶段实施计划

## 概述

本文档详细描述了 API 网关模块的分阶段实施计划，基于架构设计文档进行细化。每个阶段都有明确的目标、任务清单和验收标准。

---

## 第一阶段：基础框架搭建（1-2周）

### 目标

建立项目基础结构和基本 HTTP 服务

### 任务清单

#### 1. 项目初始化

**任务 1.1：创建 Go 模块**
- 创建目录：`services/api-gateway/`
- 初始化 `go.mod` 文件
- 设置模块名称：`github.com/flexsearch/api-gateway`

**任务 1.2：设置项目目录结构**
- 创建标准 Go 项目目录结构
- 创建 `cmd/` 目录用于入口文件
- 创建 `internal/` 目录用于内部代码
- 创建 `configs/` 目录用于配置文件

**任务 1.3：配置 Dockerfile**
- 创建多阶段构建 Dockerfile
- 配置 Go 构建环境
- 配置运行时环境

#### 2. 基础 HTTP 服务

**任务 2.1：使用 Gin 框架搭建 HTTP 服务器**
- 创建 `cmd/main.go` 入口文件
- 初始化 Gin 路由器
- 配置服务器端口和超时设置

**任务 2.2：实现基本的路由配置**
- 创建路由配置文件 `internal/config/routes.go`
- 定义基础路由规则
- 实现路由分组

**任务 2.3：创建健康检查接口**
- 实现 `GET /health` 接口
- 返回服务状态信息
- 实现基本的健康检查逻辑

**任务 2.4：实现基本的日志中间件**
- 创建 `internal/middleware/logger.go`
- 记录请求信息（方法、路径、参数）
- 记录响应信息（状态码、响应时间）

#### 3. 配置管理

**任务 3.1：使用 Viper 实现配置加载**
- 创建 `internal/config/config.go`
- 定义配置结构体
- 实现配置加载逻辑

**任务 3.2：创建配置文件**
- 创建 `configs/config.yaml`
- 定义服务器配置（端口、超时等）
- 定义日志配置（级别、输出等）

**任务 3.3：支持环境变量覆盖**
- 配置 Viper 支持环境变量
- 定义环境变量前缀
- 实现配置优先级

**任务 3.4：实现配置热更新**
- 监听配置文件变化
- 重新加载配置
- 安全更新配置

### 项目结构

```
services/api-gateway/
├── cmd/
│   └── main.go              # 入口文件
├── internal/
│   ├── config/
│   │   ├── config.go       # 配置结构
│   │   └── routes.go       # 路由配置
│   ├── middleware/
│   │   └── logger.go       # 日志中间件
│   └── handler/
│       └── health.go       # 健康检查
├── configs/
│   └── config.yaml         # 配置文件
├── go.mod
├── go.sum
└── Dockerfile
```

### 验收标准

- [ ] HTTP 服务可以正常启动
- [ ] 健康检查接口 `GET /health` 返回正常
- [ ] 配置文件可以正确加载
- [ ] 日志中间件正常记录请求
- [ ] Docker 镜像可以成功构建

---

## 第二阶段：核心功能实现（2-3周）

### 目标

实现认证、限流、请求路由等核心功能

### 任务清单

#### 1. 认证授权

**任务 1.1：实现 JWT Token 验证中间件**
- 创建 `internal/middleware/auth.go`
- 实现 JWT Token 解析
- 验证 Token 签名和有效期
- 提取用户信息存入上下文

**任务 1.2：支持 API Key 认证**
- 实现 API Key 验证逻辑
- 支持从请求头或参数中提取
- 验证 API Key 有效性

**任务 1.3：实现用户信息提取和上下文存储**
- 定义用户上下文结构
- 实现上下文存储和获取
- 支持用户 ID、角色等信息

**任务 1.4：创建认证工具类**
- 创建 `internal/util/auth.go`
- 实现 Token 生成（用于测试）
- 实现 Token 验证工具函数

#### 2. 限流熔断

**任务 2.1：基于 Redis 实现限流中间件**
- 创建 `internal/middleware/ratelimit.go`
- 实现滑动窗口算法
- 支持按用户 ID 限流
- 支持按 IP 限流

**任务 2.2：实现限流配置**
- 定义限流配置结构
- 支持不同接口不同限流策略
- 支持动态调整限流阈值

**任务 2.3：集成熔断器**
- 集成 Hystrix-go
- 实现熔断器配置
- 实现熔断器降级逻辑

**任务 2.4：实现熔断策略**
- 定义熔断触发条件
- 实现熔断状态转换
- 实现半开状态检测

#### 3. CORS 和恢复中间件

**任务 3.1：实现 CORS 跨域处理**
- 创建 `internal/middleware/cors.go`
- 配置允许的来源
- 配置允许的方法和头

**任务 3.2：实现 panic 恢复中间件**
- 创建 `internal/middleware/recovery.go`
- 捕获 panic
- 记录错误日志
- 返回友好的错误响应

**任务 3.3：统一错误响应格式**
- 定义错误响应结构
- 实现错误处理工具
- 统一错误码和消息

#### 4. 基础 API 接口

**任务 4.1：搜索接口**
- 创建 `internal/handler/search.go`
- 实现 `POST /api/v1/search`
- 实现 `GET /api/v1/search`
- 定义请求和响应结构

**任务 4.2：文档接口**
- 创建 `internal/handler/document.go`
- 实现 `POST /api/v1/documents`（添加文档）
- 实现 `GET /api/v1/documents/:id`（获取文档）
- 实现 `PUT /api/v1/documents/:id`（更新文档）
- 实现 `DELETE /api/v1/documents/:id`（删除文档）
- 实现 `POST /api/v1/documents/batch`（批量操作）

**任务 4.3：索引接口**
- 创建 `internal/handler/index.go`
- 实现 `POST /api/v1/indexes`（创建索引）
- 实现 `GET /api/v1/indexes`（列出索引）
- 实现 `GET /api/v1/indexes/:id`（获取索引）
- 实现 `DELETE /api/v1/indexes/:id`（删除索引）
- 实现 `POST /api/v1/indexes/:id/rebuild`（重建索引）

#### 5. 数据模型

**任务 5.1：创建请求模型**
- 创建 `internal/model/request.go`
- 定义搜索请求结构
- 定义文档请求结构
- 定义索引请求结构

**任务 5.2：创建响应模型**
- 创建 `internal/model/response.go`
- 定义搜索响应结构
- 定义文档响应结构
- 定义索引响应结构
- 定义错误响应结构

**任务 5.3：实现参数验证器**
- 创建 `internal/util/validator.go`
- 实现请求参数验证
- 提供友好的错误提示
- 支持自定义验证规则

### 新增文件

```
services/api-gateway/
├── internal/
│   ├── middleware/
│   │   ├── auth.go
│   │   ├── ratelimit.go
│   │   ├── cors.go
│   │   └── recovery.go
│   ├── handler/
│   │   ├── search.go
│   │   ├── document.go
│   │   └── index.go
│   ├── model/
│   │   ├── request.go
│   │   └── response.go
│   └── util/
│       ├── validator.go
│       └── error.go
```

### 验收标准

- [ ] JWT Token 验证正常工作
- [ ] API Key 认证正常工作
- [ ] 限流功能按预期工作
- [ ] 熔断器正常触发和恢复
- [ ] CORS 跨域处理正常
- [ ] panic 可以被正确捕获
- [ ] 所有基础 API 接口可以接收请求
- [ ] 参数验证正常工作

---

## 第三阶段：gRPC 集成和后端通信（2-3周）

### 目标

实现与查询协调器的 gRPC 通信

### 任务清单

#### 1. gRPC 协议定义

**任务 1.1：创建 proto 文件**
- 创建 `proto/coordinator.proto`
- 定义搜索服务接口
- 定义文档服务接口
- 定义索引服务接口

**任务 1.2：定义消息结构**
- 定义搜索请求和响应消息
- 定义文档请求和响应消息
- 定义索引请求和响应消息
- 定义健康检查消息

**任务 1.3：生成 Go 代码**
- 配置 protoc 编译器
- 生成 Go gRPC 代码
- 集成到项目中

#### 2. gRPC 客户端

**任务 2.1：实现查询协调器客户端**
- 创建 `internal/client/coordinator.go`
- 实现搜索客户端
- 实现文档客户端
- 实现索引客户端

**任务 2.2：实现连接池管理**
- 创建 `internal/client/conn.go`
- 实现连接池
- 实现连接复用
- 实现连接健康检查

**任务 2.3：实现重试机制**
- 实现指数退避重试
- 配置重试次数和间隔
- 处理重试失败

**任务 2.4：处理连接超时和错误**
- 实现连接超时配置
- 实现错误处理逻辑
- 实现错误分类和转换

#### 3. 处理器集成

**任务 3.1：搜索处理器集成**
- 更新 `internal/handler/search.go`
- 调用查询协调器搜索接口
- 实现请求格式转换
- 实现响应格式转换

**任务 3.2：文档处理器集成**
- 更新 `internal/handler/document.go`
- 调用查询协调器文档接口
- 实现请求格式转换
- 实现响应格式转换

**任务 3.3：索引处理器集成**
- 更新 `internal/handler/index.go`
- 调用查询协调器索引接口
- 实现请求格式转换
- 实现响应格式转换

**任务 3.4：实现错误处理**
- 处理 gRPC 错误
- 转换为 HTTP 错误
- 提供友好的错误消息

#### 4. 健康检查集成

**任务 4.1：实现后端服务健康检查**
- 更新 `internal/handler/health.go`
- 调用查询协调器健康检查
- 检查连接状态

**任务 4.2：实现服务状态接口**
- 实现 `GET /health/services` 接口
- 返回所有后端服务状态
- 返回连接信息

**任务 4.3：监控后端服务状态**
- 实现状态监控逻辑
- 记录状态变化
- 触发告警

### 新增文件

```
services/api-gateway/
├── internal/
│   ├── client/
│   │   ├── coordinator.go
│   │   └── conn.go
│   └── handler/
│       └── health.go (更新)
├── proto/
│   └── coordinator.proto
```

### 验收标准

- [ ] gRPC 连接正常建立
- [ ] 可以成功调用查询协调器接口
- [ ] 连接池正常工作
- [ ] 重试机制正常工作
- [ ] 健康检查可以检测后端服务状态
- [ ] 错误处理正确

---

## 第四阶段：监控、日志和优化（1-2周）

### 目标

完善可观测性和性能优化

### 任务清单

#### 1. 日志系统

**任务 1.1：使用 Zap 实现结构化日志**
- 创建 `internal/util/logger.go`
- 配置 Zap 日志器
- 实现日志级别配置
- 实现日志输出配置

**任务 1.2：实现请求/响应日志记录**
- 更新日志中间件
- 记录请求详细信息
- 记录响应详细信息
- 记录请求 ID

**任务 1.3：实现错误日志记录**
- 实现错误日志记录
- 记录错误堆栈
- 记录错误上下文

**任务 1.4：支持日志级别配置**
- 支持动态调整日志级别
- 支持不同模块不同级别
- 支持日志过滤

#### 2. 监控指标

**任务 2.1：集成 Prometheus 客户端**
- 创建 `internal/util/metrics.go`
- 配置 Prometheus 注册器
- 暴露 `/metrics` 接口

**任务 2.2：实现请求计数指标**
- 记录请求总数
- 按接口分类计数
- 按状态码分类计数

**任务 2.3：实现延迟指标**
- 记录请求延迟
- 记录 P50、P95、P99
- 按接口分类

**任务 2.4：实现错误率监控**
- 记录错误数量
- 计算错误率
- 按错误类型分类

**任务 2.5：实现自定义指标**
- 实现连接池指标
- 实现限流指标
- 实现熔断器指标

#### 3. 分布式追踪

**任务 3.1：集成 OpenTelemetry**
- 配置 OpenTelemetry SDK
- 配置追踪导出器
- 配置采样策略

**任务 3.2：实现请求追踪**
- 为每个请求生成 Trace ID
- 创建 Span
- 记录关键事件

**任务 3.3：实现跨服务追踪**
- 传递 Trace Context
- 实现 gRPC 追踪
- 实现 HTTP 追踪

#### 4. 性能优化

**任务 4.1：实现连接池优化**
- 优化连接池大小
- 实现连接复用
- 实现连接预热

**任务 4.2：实现缓存策略**
- 实现响应缓存
- 实现缓存失效
- 实现缓存预热

**任务 4.3：优化中间件执行顺序**
- 调整中间件顺序
- 优化中间件逻辑
- 减少中间件开销

**任务 4.4：压力测试和调优**
- 编写压力测试
- 执行性能测试
- 根据结果调优

### 新增文件

```
services/api-gateway/
├── internal/
│   ├── util/
│   │   ├── logger.go
│   │   └── metrics.go
│   └── middleware/
│       └── tracing.go
```

### 验收标准

- [ ] 日志输出格式正确
- [ ] 日志级别可以正确配置
- [ ] Prometheus 指标正常采集
- [ ] `/metrics` 接口正常返回
- [ ] 分布式追踪正常工作
- [ ] Trace ID 正确传递
- [ ] 性能满足要求
- [ ] 压力测试通过

---

## 第五阶段：测试和文档（1-2周）

### 目标

完善测试覆盖和文档

### 任务清单

#### 1. 单元测试

**任务 1.1：中间件单元测试**
- 测试认证中间件
- 测试限流中间件
- 测试日志中间件
- 测试恢复中间件

**任务 1.2：处理器单元测试**
- 测试搜索处理器
- 测试文档处理器
- 测试索引处理器
- 测试健康检查处理器

**任务 1.3：工具函数单元测试**
- 测试验证器
- 测试错误处理
- 测试工具函数

**任务 1.4：测试覆盖率**
- 目标覆盖率 > 80%
- 生成覆盖率报告
- 优化测试用例

#### 2. 集成测试

**任务 2.1：API 接口集成测试**
- 测试搜索接口
- 测试文档接口
- 测试索引接口
- 测试健康检查接口

**任务 2.2：gRPC 客户端集成测试**
- 测试 gRPC 连接
- 测试 gRPC 调用
- 测试错误处理

**任务 2.3：端到端测试**
- 测试完整请求流程
- 测试错误场景
- 测试边界条件

#### 3. 文档编写

**任务 3.1：API 文档**
- 编写 API 接口文档
- 提供请求示例
- 提供响应示例
- 提供错误码说明

**任务 3.2：部署文档**
- 编写部署指南
- 编写配置说明
- 编写环境要求
- 编写部署步骤

**任务 3.3：配置说明**
- 编写配置文件说明
- 提供配置示例
- 说明配置项含义
- 说明配置优先级

**任务 3.4：README.md**
- 编写项目介绍
- 编写快速开始
- 编写开发指南
- 编写贡献指南

#### 4. 部署准备

**任务 4.1：Docker 镜像构建**
- 优化 Dockerfile
- 配置多阶段构建
- 减小镜像大小
- 测试镜像运行

**任务 4.2：Kubernetes 配置文件**
- 创建 Deployment 配置
- 创建 Service 配置
- 创建 ConfigMap 配置
- 创建 Secret 配置

**任务 4.3：CI/CD 配置**
- 配置 GitHub Actions
- 配置自动构建
- 配置自动测试
- 配置自动部署

### 新增文件

```
services/api-gateway/
├── test/
│   ├── integration/
│   │   ├── api_test.go
│   │   └── grpc_test.go
│   └── unit/
│       ├── middleware_test.go
│       ├── handler_test.go
│       └── util_test.go
├── docs/
│   ├── api.md
│   ├── deployment.md
│   └── configuration.md
├── k8s/
│   ├── deployment.yaml
│   ├── service.yaml
│   ├── configmap.yaml
│   └── secret.yaml
├── .github/
│   └── workflows/
│       └── ci.yml
└── README.md
```

### 验收标准

- [ ] 所有单元测试通过
- [ ] 所有集成测试通过
- [ ] 测试覆盖率 > 80%
- [ ] API 文档完整
- [ ] 部署文档完整
- [ ] README.md 完整
- [ ] Docker 镜像可以成功构建和运行
- [ ] Kubernetes 配置文件正确
- [ ] CI/CD 流程正常

---

## 技术依赖清单

### Go 依赖

```go
require (
    github.com/gin-gonic/gin v1.9.1
    google.golang.org/grpc v1.58.0
    google.golang.org/protobuf v1.31.0
    github.com/go-redis/redis/v8 v8.11.5
    go.uber.org/zap v1.26.0
    github.com/spf13/viper v1.17.0
    github.com/golang-jwt/jwt/v5 v5.0.0
    github.com/prometheus/client_golang v1.17.0
    github.com/afex/hystrix-go v0.0.0-20160520155838-8d45e150d1b3
    go.opentelemetry.io/otel v1.19.0
    go.opentelemetry.io/otel/trace v1.19.0
    github.com/go-playground/validator/v10 v10.15.3
)
```

### 外部服务依赖

- **Redis**：缓存、限流计数
- **查询协调器**：gRPC 后端服务

---

## 实施建议

### 1. 迭代开发

- 每个阶段完成后进行代码审查
- 每个阶段完成后运行测试
- 每个阶段完成后进行演示

### 2. 持续集成

- 每个阶段完成后运行测试和构建
- 配置自动化测试
- 配置自动化构建

### 3. 文档同步

- 代码和文档同步更新
- 保持文档的准确性
- 及时更新变更

### 4. 性能监控

- 每个阶段都进行性能测试
- 记录性能指标
- 及时发现性能问题

### 5. 安全审查

- 认证、限流等安全功能需要重点测试
- 进行安全代码审查
- 进行渗透测试

---

## 时间估算

| 阶段 | 预计时间 | 依赖关系 |
|------|---------|---------|
| 第一阶段 | 1-2周 | 无 |
| 第二阶段 | 2-3周 | 第一阶段 |
| 第三阶段 | 2-3周 | 第一、二阶段 |
| 第四阶段 | 1-2周 | 第三阶段 |
| 第五阶段 | 1-2周 | 第四阶段 |
| **总计** | **7-12周** | - |

---

## 风险和缓解措施

### 风险 1：gRPC 集成复杂度高

**缓解措施**：
- 提前学习 gRPC 和 Protobuf
- 编写原型验证可行性
- 参考 gRPC 最佳实践

### 风险 2：性能不达标

**缓解措施**：
- 早期进行性能测试
- 使用性能分析工具
- 及时优化关键路径

### 风险 3：依赖服务不稳定

**缓解措施**：
- 实现完善的错误处理
- 实现熔断和降级
- 实现重试机制

### 风险 4：测试覆盖率不足

**缓解措施**：
- 制定测试计划
- 使用测试覆盖率工具
- 定期审查测试用例

---

## 总结

本实施计划将 API 网关的实现分解为 5 个阶段，每个阶段都有明确的目标、任务和验收标准。通过分阶段实施，可以：

1. 降低项目复杂度
2. 便于跟踪进度
3. 及时发现和解决问题
4. 确保代码质量
5. 提高项目成功率

建议严格按照阶段顺序执行，每个阶段完成后进行充分的测试和审查，确保质量后再进入下一阶段。
